# Домашнее задание к занятию «`Резервное копирование баз данных`» `Скворцов Денис`

**Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.** 

Для оформления вашего решения в GitHub можете воспользоваться [шаблоном](https://github.com/netology-code/sys-pattern-homework).

Название файла должно содержать номер лекции и фамилию студента. Пример названия: «12.8. Резервное копирование баз данных - Александр Александров».

Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы по решению задач задавайте в чате учебной группы.

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

---

#### 1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

---

##### Подходящий тип резервного копирования:
- Полное резервное копирование (`Full backup`), выполняемое ежедневно.

##### Если полные бэкапы слишком ресурсоёмки:  
- Полный + дифференциальный бэкап

---

##### Пример:
    Полная копия по воскресеньям,
    Ежедневные дифференциальные бэкапы с изменениями с момента последней полной копии,
    а не Инкрементальный, что требует восстанавливать цепочку: `Full` + все инкременты до нужной точки
    Для восстановления: восстанавливаем последнюю полную копию + последний дифф. бэкап.

##### Желательный подход:
- Полный бэкап ежедневно (если объём БД позволяет, например, до 100–500 ГБ - возможно ночью)
    Или `Full` + `Differential`, если объём велик

- Хранение: минимум 2 полных копии (например, за сегодня и вчера), 
    лучше недельная и месячная

- Обязательная проверка целостности бэкапов

---

#### 1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

---

##### Подходящий тип резервного копирования:
- Непрерывное архивирование журналов (`WAL/binlog`) + полная/базовая копия
- Восстановление на момент времени (`Point-in-Time Recovery`, `PITR`)

---

##### Желательный подход и обеспечение:
- Обеспечение синхронизация времени на всех серверах,
    желательно от единого источника времени

- Бинарные логи (`WAL / binlog`) должны архивироваться немедленно после заполнения сегмента 
    например, по `archive_command` или с `expire_logs_days=0`

- Регулярное тестирование `PITR`
    например, еженедельно в песочнице

- Стремление к минимальному `RPO`: 
    от секунд до минут, в зависимости от частоты архивирования журналов.

---

#### 1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Возможен, но не за счёт резервного копирования, 
а за счёт репликации + обеспечения отказоустойчивости (`failover`).
И сама репликация не заменяет резервное копирование!

- Используется синхронная или асинхронная репликация

- При падении мастера в роль вступает механизм `failover`: 
    одна из реплик автоматически повышается, а Клиентский трафик перенаправляется на нового мастера 
    через один или несколько способов одновременно: 
    - маршрутизация по `IP`,
    - перенаправление по `DNS`,
    - прокси.

##### Ограничения / требования:

- RTO ≈ секунды–десятки секунд
- RPO ≈ 0 (для синхронной репликации) или < 1 сек (для `semi-sync` / `group replication`)
- Репликация копирует все изменения - включая ошибки (`DROP DATABASE`, `UPDATE` без `WHERE`)
- Для защиты от логических ошибок всё равно нужны классические бэкапы + `PITR`
- Мониторинг репликации
- Тестирование сценариев `failover`
- Защита от `split-brain` (`кворум`, `fencing`)

##### Желательное сочетание:

- Репликация для высокой доступности (`High Availability`)
- `PITR` (`WAL`/`binlog` + бэкапы) для защиты от логических ошибок и человеческого фактора
- Мониторинг и оповещение по метрикам: 
    - `last_backup_age`,
    - `replication_lag`,
    - `disk_free`,
    - `verify_backup_status`

*Приведите ответ в свободной форме.*

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (`pgdump`/`pgrestore`).

Команды pg_dump / pg_restore из официальной документации

```bash
pg_dump -U username -h localhost -p 5432 -Fc mydb > /path/to/backup/mydb.dump
```
`-U` - пользователь подключения  
`-h`, `-p` - хост и порт  
`-Fc` - формат custom (бинарный, сжатый, поддерживает избирательное восстановление)  
`mydb` - имя базы данных  
`>` - перенаправление вывода в файл

```bash
# создать БД заново
createdb -U username -h localhost -p 5432 -T template0 mydb_restored

# восстановить
pg_restore -U username -h localhost -p 5432 -d mydb_restored /path/to/backup/mydb.dump
```


2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Автоматизировать резервное копирование PostgreSQL можно используя:

---

- Простую автоматизацию через `cron`

файл `~/.pgpass` должен содержать строку:
```ini
localhost:5432:mydb:username:password
```
```bash
# ограничение прав только до владельца
chmod 600 ~/.pgpass

# Ежедневный дамп в 01:00
0 1 * * * pg_dump -U username -h localhost -Fc mydb > /srv/backups/mydb_$(date +\%Y-\%m-\%d).dump
```

---

- Физический бэкап + `WAL` для `PITR`

1. Настроить `wal_level = replica`, `archive_mode = on`, `archive_command = 'cp %p /wal_archive/%f'`  
2. Выполнять регулярный `base backup`:
```pg
pg_basebackup -U replicator -h localhost -D /srv/backups/base_$(date +\%Y\%m\%d) -Ft -z -P
```
- При восстановлении:
    - распаковать base backup  
    - создать `postgresql.auto.conf` с `restore_command = 'cp /wal_archive/%f %p'`  
    - запустить PostgreSQL — он применит WAL-логи и остановится в нужный момент 
        (recovery_target_time = '2025-12-20 14:30:00')

*Приведите ответ в свободной форме.*

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

---

Задания, помеченные звёздочкой, - дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.
