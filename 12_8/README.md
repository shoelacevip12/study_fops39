# Домашнее задание к занятию «`Резервное копирование баз данных`» `Скворцов Денис`

**Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.** 

Для оформления вашего решения в GitHub можете воспользоваться [шаблоном](https://github.com/netology-code/sys-pattern-homework).

Название файла должно содержать номер лекции и фамилию студента. Пример названия: «12.8. Резервное копирование баз данных - Александр Александров».

Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы по решению задач задавайте в чате учебной группы.

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

---

#### 1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

---

##### Подходящий тип резервного копирования:
- Полное резервное копирование (`Full backup`), выполняемое ежедневно.

##### Если полные бэкапы слишком ресурсоёмки:
- Полный + дифференциальный бэкап

---

##### Пример:
Полная копия по воскресеньям,
Ежедневные дифференциальные бэкапы с изменениями с момента последней полной копии,
а не Инкрементальный, что требует восстанавливать цепочку: `Full` + все инкременты до нужной точки
Для восстановления: восстанавливаем последнюю полную копию + последний дифф. бэкап.

##### Желательный подход:
- Полный бэкап ежедневно (если объём БД позволяет, например, до 100–500 ГБ - возможно ночью)
Или `Full` + `Differential`, если объём велик

- Хранение: минимум 2 полных копии (например, за сегодня и вчера), 
лучше недельная и месячная

- Обязательная проверка целостности бэкапов

---

#### 1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

---

##### Подходящий тип резервного копирования:
- Непрерывное архивирование журналов (`WAL/binlog`) + полная/базовая копия
- Восстановление на момент времени (`Point-in-Time Recovery`, `PITR`)

---

##### Желательный подход и обеспечение:
- Обеспечение синхронизация времени на всех серверах,
желательно от единого источника времени

- Бинарные логи (`WAL / binlog`) должны архивироваться немедленно после заполнения сегмента 
например, по `archive_command` или с `expire_logs_days=0`

- Регулярное тестирование `PITR`
например, еженедельно в песочнице

- Стремление к минимальному `RPO`: 
от секунд до минут, в зависимости от частоты архивирования журналов.

---

#### 1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Возможен, но не за счёт резервного копирования, 
а за счёт репликации + обеспечения отказоустойчивости (`failover`).
И сама репликация не заменяет резервное копирование!

- Используется синхронная или асинхронная репликация

- При падении мастера в роль вступает механизм `failover`: 
одна из реплик автоматически повышается, а Клиентский трафик перенаправляется на нового мастера 
через один или несколько способов одновременно: 
- маршрутизация по `IP`,
- перенаправление по `DNS`,
- прокси.

##### Ограничения / требования:

- RTO ≈ секунды–десятки секунд
- RPO ≈ 0 (для синхронной репликации) или < 1 сек (для `semi-sync` / `group replication`)
- Репликация копирует все изменения - включая ошибки (`DROP DATABASE`, `UPDATE` без `WHERE`)
- Для защиты от логических ошибок всё равно нужны классические бэкапы + `PITR`
- Мониторинг репликации
- Тестирование сценариев `failover`
- Защита от `split-brain` (`кворум`, `fencing`)

##### Желательное сочетание:

- Репликация для высокой доступности (`High Availability`)
- `PITR` (`WAL`/`binlog` + бэкапы) для защиты от логических ошибок и человеческого фактора
- Мониторинг и оповещение по метрикам: 
- `last_backup_age`,
- `replication_lag`,
- `disk_free`,
- `verify_backup_status`

*Приведите ответ в свободной форме.*

---

### Задание 2. PostgreSQL

#### 2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (`pgdump`/`pgrestore`).

Команды pg_dump / pg_restore из официальной документации

```bash
pg_dump -U username -h localhost -p 5432 -Fc mydb > /path/to/backup/mydb.dump
```
`-U` - пользователь подключения
`-h`, `-p` - хост и порт
`-Fc` - формат custom (бинарный, сжатый, поддерживает избирательное восстановление)
`mydb` - имя базы данных
`>` - перенаправление вывода в файл

```bash
# создать БД заново
createdb -U username -h localhost -p 5432 -T template0 mydb_restored

# восстановить
pg_restore -U username -h localhost -p 5432 -d mydb_restored /path/to/backup/mydb.dump
```

---

#### 2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

Автоматизировать резервное копирование PostgreSQL можно используя:

---

- Простую автоматизацию через `cron`

файл `~/.pgpass` должен содержать строку:
```ini
localhost:5432:mydb:username:password
```
```bash
# ограничение прав только до владельца
chmod 600 ~/.pgpass

# Ежедневный дамп в 01:00
0 1 * * * pg_dump -U username -h localhost -Fc mydb > /srv/backups/mydb_$(date +\%Y-\%m-\%d).dump
```

---

- Физический бэкап + `WAL` для `PITR`

**1. Настроить `wal_level = replica`, `archive_mode = on`, `archive_command = 'cp %p /wal_archive/%f'`**
2. Выполнять регулярный `base backup`:
```pg
pg_basebackup -U replicator -h localhost -D /srv/backups/base_$(date +\%Y\%m\%d) -Ft -z -P
```
- При восстановлении:
- распаковать base backup
- создать `postgresql.auto.conf` с `restore_command = 'cp /wal_archive/%f %p'`
- запустить PostgreSQL - он применит WAL-логи и восстановится в нужный момент 
(recovery_target_time = '2025-12-20 14:30:00')

*Приведите ответ в свободной форме.*

---

### Задание 3. MySQL

#### 3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 


В MySQL отсутствует встроенная команда для инкрементного резервного
копирования, подобная `pg_dump`+`WAL` в PostgreSQL, поскольку стандартный
инструмент `mysqldump` не поддерживает такую возможность. Инкрементные
резервные копии создаются с использованием бинарных логов (`binary logs`).
Сам же бинарный лог по своей сути и является инкрементной резервной копией.

###### Процедура выполнения инкрементного резервного копирования в MySQL:
**1. Включение ведения бинарных логов (в файле `my.cnf`):**
```ini
[mysqld]
log-bin = mysql-bin
server-id = 1
```
**2. Выполнение полного резервного копирования:**
```ini
mysqldump --all-databases --single-transaction \
--master-data=2 --flush-logs > /backup/full_$(date +%F).sql
```
`--master-data=2` - записывает позицию бинарного лога (`CHANGE MASTER TO ...`) в виде комментария внутри дампа.
`--flush-logs` - инициирует создание нового бинарного лога, предоставляя полную основу для последующих инкрементных изменений.

**3. Копирование новых бинарных логов для инкрементных изменений:**
- Получение списка активных файлов бинарных логов:
```bash
mysql -e "SHOW BINARY LOGS;"
```
- Копирование только тех файлов бинарных логов, которые были созданы после полного бэкапа:
```bash
cp /var/lib/mysql/mysql-bin.000002 /backup/incr/
cp /var/lib/mysql/mysql-bin.000003 /backup/incr/
```
- или архивирование:
```bash
tar -czf /backup/incr/binlogs_$(date +%F_%H%M).tar.gz /var/lib/mysql/mysql-bin.*
```
---

**Также можно использовать утилиту `mysqlbinlog` для экспорта изменений в SQL-формате:**
```bash
mysqlbinlog \
--start-position=154 \
--stop-datetime="2025-12-26 10:00:00" \
/var/lib/mysql/mysql-bin.000002 > /backup/incr/incr_20251226.sql
```

---

Существуют еще и коммерческий платный инструмент MySQL Enterprise Backup (`MEB`) и он не совместим с MySQL Community Edition. 
`MEB`, делает инкрементный бэкап одной командой:
```bash
mysqlbackup \
--user=root \
--password=... \
--backup-dir=/backup/incr_$(date +%F) \
--incremental --incremental-base=dir:/backup/full_latest \
backup
```
---

##### 3.2.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Репликация может дать преимущества перед бэкапами в следующих случаях:*

**1. Минимизация RPO (уровень потери данных)**

`RPO` выступает целевым показателем для организации. 
Потери данных составляет примерно секунды или миллисекунды при использовании синхронной или асинхронной репликации. 
Бинарные логи применяются практически мгновенно. 

В то время как при ежедневном резервном копировании `RPO` может достигать 24 часов.

**2. Сокращение RTO (времени простоя)**

`RTO`выступает целевым показателем для организации. Задержка доступа может составлять всего несколько секунд или минут во время переключения при отказе (`failover`). Если главный сервер выходит из строя, ведомый сервер (`slave`) может быть повышен до главного без необходимости восстановления из архива. 

В то же время, для восстановления из резервной копии требуется процесс восстановления (`restore`), который может занимать часы при работе с терабайтами данных.

**3. Масштабирование чтения на ведомых серверах (`read scaling`)**

Этот подход снижает нагрузку на главный сервер, повышая масштабируемость. 
Репликация используется в режиме реального времени, выступая одновременно и как резервная копия, и как ресурс для активной работы.
Резервные копии такой возможности не предоставляют. 

**4. Для аналитики и отчётности**

Тяжёлые `SELECT`-запросы не будут мешать `OLTP`-трафику. 

Есть возможно запускать такие инструменты, как `pt-query-digest`, `mysqldumpslow` и `ANALYZE TABLE`, 
не сильно влияя на рабочую (`production`) базу.

**5. Тестирование на актуальных данных**

Реплика служит тестовой (`staging`) средой.

Без опаски для `production` можно обновлять версию, настраивать конфигурации и тестировать `DDL`-команды.

**6. Аварийный откат без Остановки**

"Горячее" резервное копирование рабочей базы данных.
Реплика - это функционирующая база данных. 

Стандартная резервная копия является неактивной базой данных,
а для проверки целостности необходимо разворачивать резервную копию в контролируемом окружении(песочнице).


*Приведите ответ в свободной форме.*

---

Задания, помеченные звёздочкой, - дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.
